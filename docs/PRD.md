# Sitemap Monitor - 产品需求文档 (PRD)

**文档版本**: v1.1
**最后更新**: 2025-01-25
**项目状态**: MVP 已完成 ✅

---

## 1. 产品概述

### 1.1 产品背景
在竞争激烈的市场环境中，及时了解竞品网站的内容更新对于制定营销策略和产品规划至关重要。目前缺乏一个简单易用的工具来自动监控竞品网站的新页面发布情况。

### 1.2 产品定位
Sitemap Monitor 是一款面向产品经理、市场分析师和 SEO 从业者的竞品网站监控工具，通过 Google Custom Search API 自动发现并追踪竞品网站新发布的页面。

### 1.3 目标用户

| 用户角色 | 使用场景 | 核心需求 |
|---------|---------|---------|
| 产品经理 | 监控竞品功能页面更新 | 了解竞品产品动态 |
| 市场分析师 | 追踪竞品营销活动页面 | 分析竞品市场策略 |
| SEO 从业者 | 监控竞品内容发布频率 | 优化自身内容策略 |
| 内容运营 | 追踪行业内容趋势 | 获取内容灵感 |

### 1.4 核心价值
- **自动化监控**：定时自动发现竞品新页面，无需人工定期检查
- **多站点管理**：统一管理多个竞品网站
- **未读管理**：清晰标记未查看的新页面，第一时间获知更新
- **数据永久保留**：历史数据可追溯，支持长期分析

---

## 2. 功能需求

### 2.1 网站管理

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 添加网站 | 输入网站域名，设置监控频率 | P0 |
| 编辑网站 | 修改网站名称、域名、监控频率 | P0 |
| 删除网站 | 删除网站及其所有历史数据 | P0 |
| 网站列表 | 展示所有监控中的网站及状态 | P0 |
| 手动抓取 | 立即触发一次抓取，可选时间范围 | P0 |

**网站信息字段：**
- 网站名称（可自定义）
- 域名
- 监控频率（每12小时 / 每天 / 每周）
- 上次抓取时间
- 状态（正常 / 异常）

### 2.2 页面监控

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 新页面发现 | 通过 Google Search 发现新页面 | P0 |
| 页面列表 | 展示所有发现的页面，按时间倒序 | P0 |
| 未读标记 | 新页面默认为未读，支持标记已读 | P0 |
| 批量已读 | 一键标记全部已读 | P1 |
| 筛选功能 | 按网站、阅读状态筛选 | P1 |

**页面信息字段：**
- 页面标题
- 页面 URL
- 发现时间（首次在 Google 搜索结果中发现）
- 阅读状态（未读 / 已读）
- 所属网站

### 2.3 抓取设置

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 监控频率 | 每个网站可独立设置 | P0 |
| 时间范围 | 手动抓取时可选择时间范围 | P0 |
| API Key 配置 | 用户配置自己的 Google API Key | P0 |

**监控频率选项：**
- 每 12 小时
- 每天
- 每周

**时间范围选项（手动抓取）：**
- 最近 1 天
- 最近 1 周
- 最近 2 周
- 最近 1 个月

### 2.4 系统设置

| 功能 | 描述 | 优先级 |
|------|------|--------|
| Google API Key | 配置 Custom Search API Key | P0 |
| Search Engine ID | 配置 Custom Search Engine ID | P0 |

---

## 3. 技术方案

### 3.1 技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| **框架** | Next.js 14 (App Router) | 全栈框架，前后端一体 |
| **语言** | TypeScript | 类型安全 |
| **数据库** | SQLite + Prisma | 轻量级，零配置 |
| **UI** | Tailwind CSS + shadcn/ui | 快速构建美观界面 |
| **定时任务** | node-cron | 简单可靠 |
| **HTTP** | fetch | 调用 Google API |

### 3.2 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Next.js App                             │
├─────────────────────────────────────────────────────────────┤
│  Frontend (React)           │  Backend (API Routes)         │
│  ┌──────────────────────┐   │  ┌──────────────────────┐    │
│  │ 页面列表             │   │  │ /api/sites           │    │
│  │ 网站管理             │   │  │ /api/pages           │    │
│  │ 设置页面             │   │  │ /api/crawl           │    │
│  └──────────────────────┘   │  │ /api/settings        │    │
│                             │  └──────────────────────┘    │
├─────────────────────────────────────────────────────────────┤
│                      Services                                │
│  ┌──────────────────────┐   ┌──────────────────────┐       │
│  │ Google Search 服务   │   │ 定时任务调度器       │       │
│  └──────────────────────┘   └──────────────────────┘       │
├─────────────────────────────────────────────────────────────┤
│                      Database (SQLite)                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │  sites   │  │  pages   │  │ settings │                  │
│  └──────────┘  └──────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 Google Custom Search API

**请求格式：**
```
GET https://www.googleapis.com/customsearch/v1
  ?key={API_KEY}
  &cx={SEARCH_ENGINE_ID}
  &q=site:competitor.com after:2024-01-18
  &num=10
  &start=1
```

**响应数据（我们需要的字段）：**
```json
{
  "items": [
    {
      "title": "页面标题",
      "link": "https://competitor.com/page-url"
    }
  ]
}
```

**分页处理：**
- 每次请求最多 10 条结果
- 通过 `start` 参数分页（1, 11, 21, ...）
- 最多获取 100 条（start 最大 91）

---

## 4. 数据模型

### 4.1 网站表 (sites)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT (UUID) | 主键 |
| name | TEXT | 网站名称 |
| domain | TEXT | 网站域名 |
| crawl_interval | TEXT | 抓取频率：12h / 1d / 1w |
| last_crawled_at | DATETIME | 上次抓取时间 |
| status | TEXT | 状态：active / error |
| error_message | TEXT | 错误信息（可选） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 4.2 页面表 (pages)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | TEXT (UUID) | 主键 |
| site_id | TEXT | 关联网站 ID |
| url | TEXT | 页面 URL（唯一） |
| title | TEXT | 页面标题 |
| discovered_at | DATETIME | 发现时间 |
| is_read | BOOLEAN | 是否已读，默认 false |
| created_at | DATETIME | 创建时间 |

**索引：**
- `site_id` - 按网站查询
- `is_read` - 按阅读状态筛选
- `discovered_at` - 按发现时间排序
- `url` - 唯一约束（防止重复）

### 4.3 设置表 (settings)

| 字段 | 类型 | 说明 |
|------|------|------|
| key | TEXT | 配置键（主键） |
| value | TEXT | 配置值 |

**初始配置项：**
- `google_api_key` - Google API Key
- `google_cx` - Search Engine ID

---

## 5. 核心工作流程

### 5.1 添加新网站

```
用户输入域名 + 名称 + 监控频率
              │
              ▼
       ┌──────────────┐
       │ 验证域名格式 │
       └──────────────┘
              │
              ▼
       ┌──────────────┐
       │ 保存到数据库 │
       └──────────────┘
              │
              ▼
       ┌──────────────┐
       │ 可选：立即   │
       │ 执行首次抓取 │
       └──────────────┘
```

### 5.2 抓取流程

```
触发抓取（定时 or 手动）
              │
              ▼
       ┌──────────────────────┐
       │ 构造搜索查询          │
       │ site:{domain}        │
       │ after:{date}         │
       └──────────────────────┘
              │
              ▼
       ┌──────────────────────┐
       │ 调用 Google API      │
       │ 分页获取所有结果     │
       │ (最多 100 条)        │
       └──────────────────────┘
              │
              ▼
       ┌──────────────────────┐
       │ 遍历结果             │
       │ 检查 URL 是否已存在  │
       └──────────────────────┘
              │
              ├── 已存在 → 跳过
              │
              └── 新 URL → 存入数据库
                           标记为未读
              │
              ▼
       ┌──────────────────────┐
       │ 更新网站的           │
       │ last_crawled_at      │
       └──────────────────────┘
```

### 5.3 定时任务

```
每分钟检查一次
       │
       ▼
┌──────────────────────────┐
│ 查询所有网站             │
│ 计算下次应抓取时间       │
│ now >= last + interval   │
└──────────────────────────┘
       │
       ▼
┌──────────────────────────┐
│ 对需要抓取的网站         │
│ 执行抓取流程             │
│ 默认时间范围：最近1周    │
└──────────────────────────┘
```

---

## 6. 页面设计

### 6.1 页面结构

```
/                     → 首页（页面列表）
/sites                → 网站管理
/sites/new            → 添加网站
/sites/[id]/edit      → 编辑网站
/settings             → 系统设置（API Key 配置）
```

### 6.2 首页 - 页面列表

```
┌─────────────────────────────────────────────────────────────┐
│  Sitemap Monitor                              [设置] [网站] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  筛选: [所有网站 ▼] [所有状态 ▼]        [全部标记已读]     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🔵 新品发布：XX产品                                  │   │
│  │    competitor.com/new-product                        │   │
│  │    发现于 2024-01-20 14:30  •  来自 竞品A            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🔵 帮助文档更新                                      │   │
│  │    competitor.com/help/guide                         │   │
│  │    发现于 2024-01-19 09:00  •  来自 竞品B            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ✓ 关于我们页面改版                                   │   │
│  │    competitor.com/about                              │   │
│  │    发现于 2024-01-18 16:00  •  来自 竞品A            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 网站管理页面

```
┌─────────────────────────────────────────────────────────────┐
│  网站管理                                      [+ 添加网站] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 竞品A                                    [抓取] [编辑] │ │
│  │ competitor-a.com                                     │   │
│  │ 每天抓取  •  上次抓取: 2024-01-20 08:00  •  状态: ✅  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 竞品B                                    [抓取] [编辑] │ │
│  │ competitor-b.com                                     │   │
│  │ 每周抓取  •  上次抓取: 2024-01-15 10:00  •  状态: ✅  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 手动抓取弹窗

```
┌─────────────────────────────────────┐
│  抓取 - 竞品A                    ✕  │
├─────────────────────────────────────┤
│                                     │
│  选择时间范围:                      │
│                                     │
│  ○ 最近 1 天                        │
│  ● 最近 1 周                        │
│  ○ 最近 2 周                        │
│  ○ 最近 1 个月                      │
│                                     │
│            [取消]  [开始抓取]       │
│                                     │
└─────────────────────────────────────┘
```

---

## 7. 项目目录结构

```
sitemap-monitor/
├── src/
│   ├── app/                      # Next.js App Router
│   │   ├── layout.tsx            # 根布局
│   │   ├── page.tsx              # 首页（页面列表）
│   │   ├── sites/
│   │   │   ├── page.tsx          # 网站列表
│   │   │   ├── new/
│   │   │   │   └── page.tsx      # 添加网站
│   │   │   └── [id]/
│   │   │       └── edit/
│   │   │           └── page.tsx  # 编辑网站
│   │   ├── settings/
│   │   │   └── page.tsx          # 设置页面
│   │   └── api/
│   │       ├── sites/
│   │       │   └── route.ts      # 网站 CRUD API
│   │       ├── pages/
│   │       │   └── route.ts      # 页面 API
│   │       ├── crawl/
│   │       │   └── route.ts      # 抓取 API
│   │       └── settings/
│   │           └── route.ts      # 设置 API
│   ├── components/
│   │   ├── ui/                   # shadcn/ui 组件
│   │   ├── PageList.tsx          # 页面列表组件
│   │   ├── SiteCard.tsx          # 网站卡片组件
│   │   ├── CrawlDialog.tsx       # 抓取弹窗
│   │   └── Header.tsx            # 顶部导航
│   ├── lib/
│   │   ├── db.ts                 # Prisma 客户端
│   │   ├── google-search.ts      # Google API 封装
│   │   └── scheduler.ts          # 定时任务
│   └── types/
│       └── index.ts              # 类型定义
├── prisma/
│   └── schema.prisma             # 数据库 Schema
├── public/
├── docs/
│   └── PRD.md                    # 本文档
├── package.json
├── tailwind.config.js
├── tsconfig.json
└── README.md
```

---

## 8. API 设计

### 8.1 网站管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/sites | 获取所有网站 |
| POST | /api/sites | 添加网站 |
| PUT | /api/sites/[id] | 更新网站 |
| DELETE | /api/sites/[id] | 删除网站 |

### 8.2 页面管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/pages | 获取页面列表（支持筛选） |
| PUT | /api/pages/[id]/read | 标记已读 |
| PUT | /api/pages/read-all | 全部标记已读 |

### 8.3 抓取

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/crawl | 触发抓取 |

**请求体：**
```json
{
  "siteId": "xxx",
  "dateRange": "1w"  // 1d, 1w, 2w, 1m
}
```

### 8.4 设置

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/settings | 获取设置 |
| PUT | /api/settings | 更新设置 |

---

## 9. 开发状态

### Phase 1: 基础框架 ✅ 已完成
- [x] 初始化 Next.js 16 项目
- [x] 配置 Prisma 5 + SQLite
- [x] 配置 Tailwind + shadcn/ui
- [x] 创建数据库 Schema
- [x] 启用深色主题

### Phase 2: 核心功能 ✅ 已完成
- [x] 网站 CRUD API
- [x] Google Search API 集成
- [x] 手动抓取功能实现
- [x] 页面列表展示
- [x] 侧边栏布局（网站列表 + 页面表格）

### Phase 3: 完善功能 🔄 进行中
- [x] 未读/已读状态
- [x] 时间范围选择器
- [ ] 筛选功能
- [ ] 定时任务调度
- [x] 设置页面（API Key 配置）

### Phase 4: 优化 📋 规划中
- [ ] 错误处理增强
- [ ] 加载状态优化
- [ ] 响应式设计
- [ ] 部署配置（Vercel/Docker）
- [ ] 数据导出功能

---

## 10. 附录

### 10.1 Google Custom Search API 配置步骤

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 创建项目
3. 启用 Custom Search API
4. 创建 API Key
5. 访问 [Programmable Search Engine](https://programmablesearchengine.google.com/)
6. 创建搜索引擎，选择"搜索整个网络"
7. 获取 Search Engine ID (cx)

### 10.2 API 配额说明

- 免费版：100 次/天
- 付费版：$5/1000 次查询
- 单次查询最多 10 条结果
- 最多翻页到第 100 条结果

### 10.3 时间范围参数

| 选项 | after 参数值 |
|------|-------------|
| 最近 1 天 | 当前日期 - 1 天 |
| 最近 1 周 | 当前日期 - 7 天 |
| 最近 2 周 | 当前日期 - 14 天 |
| 最近 1 个月 | 当前日期 - 30 天 |

---

## 11. 风险与限制

### 11.1 已知限制

| 限制项 | 说明 |
|-------|------|
| Google API 配额 | 免费版每天 100 次查询 |
| 索引延迟 | Google 索引新页面通常需要 1-7 天 |
| 结果数量上限 | 单次搜索最多返回 100 条结果 |

### 11.2 风险应对

| 风险 | 应对措施 |
|-----|---------|
| API 配额用尽 | 提醒用户升级付费计划或减少抓取频率 |
| 网站屏蔽 Google 爬虫 | 无法获取该网站数据，需人工监控 |
| API 服务不可用 | 本地缓存最近一次抓取结果 |

---

## 12. 界面预览

### 12.1 当前实现的布局

```
┌────────────────────────────────────────────────────┐
│  Header: Sitemap Monitor                    [设置] │
├──────────────┬─────────────────────────────────────┤
│              │                                     │
│  网站列表     │  页面列表                           │
│  (Sidebar)   │  ┌─────────────────────────────────┐│
│              │  │ 网站名称    [时间范围▼] [抓取]  ││
│  ○ 网站A (5) │  │ domain.com · 100 URLs           ││
│  ● 网站B (3) │  ├─────────────────────────────────┤│
│  ○ 网站C (0) │  │ □ 页面标题1     2024-01-15      ││
│              │  │ □ 页面标题2     2024-01-14      ││
│  [+ 添加网站] │  │ ■ 页面标题3     2024-01-13      ││
│              │  │ ...                             ││
│              │  └─────────────────────────────────┘│
└──────────────┴─────────────────────────────────────┘
```

### 12.2 交互说明

1. **左侧边栏**：显示所有监控的网站，点击切换选中状态
2. **右侧页面头部**：
   - 网站名称和域名信息
   - 时间范围选择器（默认：最近 1 天）
   - 抓取按钮
3. **页面表格**：显示发现的页面列表，支持标记已读

---

**文档结束**
